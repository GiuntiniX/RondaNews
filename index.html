<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radar de Notícias</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/GiuntiniX/RadarNews/main/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .view-filter-active, .date-filter-active, .filter-active, .agg-view-btn-active { background-color: #06b6d4 !important; color: #ffffff !important; font-weight: 600; }
        .highlight { background-color: #fde047; color: #1e293b; padding: 0 2px; border-radius: 2px; }
        .media-dropdown-active { background-color: #06b6d4; color: #ffffff; font-weight: 600; }
        .dropdown-menu { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .dropdown-menu.hidden { opacity: 0; transform: translateY(10px); pointer-events: none; }
        #toast, #welcomeBanner { transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; }
        #backToTopBtn { transition: opacity 0.3s, transform 0.3s; }
        .lead-story .news-title { font-size: 1.25rem; }
        .save-icon { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .saved-pop { transform: scale(1.3); }
        .has-tooltip { position: relative; cursor: pointer; }
        .has-tooltip::after { content: attr(data-tooltip); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background-color: #1e293b; color: #e2e8f0; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s ease, transform 0.2s ease; z-index: 10; }
        .has-tooltip:hover::after { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        #mainViewTabs::-webkit-scrollbar, .category-tabs-container::-webkit-scrollbar { display: none; }
        #mainViewTabs, .category-tabs-container { -ms-overflow-style: none; scrollbar-width: none; }
        .entity-tag { background-color: #334155; color: #cbd5e1; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 500; }
        .portal-column-container { display: grid; scroll-behavior: smooth; grid-auto-flow: column; grid-auto-columns: minmax(320px, 1fr); overflow-x: auto; gap: 1rem; padding-bottom: 1rem; height: 75vh; }
        .portal-column-container::-webkit-scrollbar { display: none; }
        .portal-column { transition: opacity 0.5s ease-in-out; }
        .portal-news-list, #topicDetailContent { scrollbar-width: thin; scrollbar-color: #475569 #1e293b; }
        .portal-news-list::-webkit-scrollbar, #topicDetailContent::-webkit-scrollbar { width: 6px; }
        .portal-news-list::-webkit-scrollbar-track, #topicDetailContent::-webkit-scrollbar-track { background: #1e293b; }
        .portal-news-list::-webkit-scrollbar-thumb, #topicDetailContent::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .topic-card { cursor: pointer; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .topic-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .category-tab { border-bottom: 3px solid transparent; }
        .category-followed-text { color: #60a5fa !important; }
        .category-priority-text { color: #f59e0b !important; font-weight: 700; }
    </style>
</head>
<body class="text-slate-200 antialiased">

    <div id="welcomeBanner" role="alert" class="hidden fixed top-5 right-5 w-96 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-50 p-4">
        <button id="closeWelcomeBannerBtn" type="button" aria-label="Fechar" class="absolute top-2 right-2 text-slate-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
        <h3 class="font-bold text-cyan-400 mb-3 text-base">Bem-vindo ao Radar de Notícias!</h3>
        <p class="text-sm text-slate-300 mb-3">Conheça as seções principais no menu de navegação:</p>
        <ul class="space-y-3 text-sm text-slate-300 list-inside">
            <li><b>Últimas Notícias:</b> Feed principal com tudo de mais recente.</li>
            <li><b>Meu Radar:</b> Acompanhe apenas os tópicos que você segue.</li>
            <li><b>Cobertura da Mídia:</b> Análise de pautas e veículos.</li>
            <li><b>Minhas Rondas:</b> Organize suas apurações.</li>
        </ul>
        <p class="text-xs text-slate-400 mt-4 pt-2 border-t border-slate-600/50">Dica: A ferramenta busca por novas matérias a cada 20 minutos e te notifica aqui!</p>
    </div>

    <div class="container mx-auto p-2 md:p-8">
        
        <header class="text-center mb-6 relative">
            <div class="flex justify-center items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" stroke-opacity="0.4"></circle><circle cx="12" cy="12" r="6" stroke-opacity="0.4"></circle><circle cx="12" cy="12" r="2"></circle><path stroke-linecap="round" stroke-linejoin="round" d="M12 2v10l-4 4"></path></svg>
                <h1 class="text-2xl md:text-4xl font-bold text-cyan-400">Radar de Notícias</h1>
            </div>
            <p class="text-slate-400 mt-2">A velocidade da informação ao seu alcance.</p>
            <p class="text-sm text-slate-500 mt-1">
                Ferramenta desenvolvida por: <a href="mailto:guilherme.giuntini@telefonica.com" class="text-cyan-400 hover:underline">Guilherme Giuntini</a>
            </p>
            <div id="lastUpdated" class="text-sm text-slate-500 mt-2 flex justify-center items-center gap-2"></div>
        </header>

        <div class="sticky top-2 bg-slate-800/80 backdrop-blur-sm z-10 p-2 md:p-4 rounded-xl border border-slate-700 shadow-lg mb-8 flex flex-col gap-3">
            <div id="searchBarWrapper" class="flex flex-wrap items-center justify-center">
                <div class="flex-grow flex items-center bg-slate-900 rounded-lg p-1 border border-slate-700 w-full lg:w-auto max-w-4xl">
                    <input type="text" id="searchInput" placeholder='Busque por termos ou use "fonte:g1.globo.com"' class="w-full bg-transparent text-slate-200 placeholder-slate-500 focus:outline-none px-4 py-2">
                    <button id="clearSearchBtn" aria-label="Limpar busca" class="text-slate-500 hover:text-slate-300 transition-colors duration-200 p-2 hidden"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    <button id="searchButton" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300 flex items-center gap-2 disabled:bg-slate-600 disabled:cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><span id="buttonText">Buscar</span></button>
                </div>
            </div>
            <nav class="flex justify-center" aria-label="Navegação Principal">
                <div id="mainViewTabs" class="flex justify-start md:justify-center bg-slate-700/50 p-1 rounded-lg w-full overflow-x-auto whitespace-nowrap">
                    <button id="viewFilterRadar" class="view-filter-active text-white px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="true"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6" /></svg>Últimas Notícias</button>
                    <button id="viewFilterForYou" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="false"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.538 1.118l-2.8-2.034a1 1 0 00-1.176 0l-2.8 2.034c-.783.57-1.838-.197-1.538-1.118l1.07-3.292a1 1 0 00-.364-1.118l-2.8-2.034c-.783-.57-.38-1.81.588-1.81h3.462a1 1 0 00.95-.69l1.07-3.292z" /></svg>Meu Radar</button>
                    <button id="viewFilterAggregate" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-1.5" aria-pressed="false"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Cobertura da Mídia</button>
                    <button id="rondasBtn" aria-label="Abrir Minhas Rondas" class="text-slate-300 hover:bg-slate-600/50 px-4 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200 flex items-center gap-2 relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                        Minhas Rondas
                        <span id="rondaCountBadge" class="absolute -top-2 -right-2 bg-cyan-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full">0</span>
                    </button>
                </div>
            </nav>
            <div id="secondaryFilters" class="flex justify-center items-center flex-wrap gap-x-4 gap-y-2 pt-2 border-t border-slate-700/50">
                <div id="dateFilterContainer" class="flex items-center gap-2 p-1 rounded-lg">
                    <button id="dateFilterToday" class="date-filter-active text-white text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200" data-date-key="hoje" aria-pressed="true">Hoje</button>
                    <button id="dateFilterLastWeek" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 hover:bg-slate-700" data-date-key="ultima_semana" aria-pressed="false">Última Semana</button>
                </div>
                <div id="mediaFilterDropdown" class="relative">
                    <button id="mediaFilterButton" class="text-slate-300 text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2" aria-expanded="false" aria-controls="mediaDropdownMenu"><span id="currentMediaLabel">Mídia: Todos</span><svg id="mediaDropdownIcon" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                    <div id="mediaDropdownMenu" class="dropdown-menu hidden absolute right-0 mt-2 w-48 bg-slate-700 border border-slate-600 rounded-lg shadow-xl z-20 origin-top-right">
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg media-dropdown-active" data-media-key="todos">Todos</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="texto">Notícias 📝</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="video">Vídeo ▶️</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="podcast">Podcast 🎙️</button>
                        <button class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-600 rounded-lg" data-media-key="imagem">Imagem/Galeria 🖼️</button>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="refreshButton" aria-label="Atualizar notícias" class="text-slate-300 text-sm font-semibold px-3 py-1.5 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg><span>Atualizar</span></button>
                </div>
            </div>
            <p id="apiError" class="text-center text-red-400 text-sm h-4"></p>
        </div>
        
        <div id="radarContainer">
            <div class="lg:grid lg:grid-cols-10 lg:gap-8">
                <div class="lg:col-span-10">
                    <div id="contentCounter" class="text-sm text-slate-400 mb-4 h-5"></div>
                    <div class="mb-8 bg-slate-800 rounded-xl p-4 border border-slate-700">
                        <div class="flex justify-between items-center mb-2">
                             <h2 class="text-lg font-bold text-cyan-400">Navegue por Editorial</h2>
                             <button id="clearFollowedBtn" class="hidden text-xs text-red-400 hover:text-red-300 font-semibold transition-colors duration-200">Limpar Tópicos</button>
                        </div>
                        <div id="categoriesContainer" class="border-t border-slate-700">
                        </div>
                    </div>
                    <main id="resultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></main>
                    <div id="messageState" class="hidden text-center py-16"><svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-slate-600 mb-4"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg><h3 id="messageTitle" class="text-xl font-semibold text-slate-300">Nenhum resultado</h3><p id="messageText" class="text-slate-500">Tente um termo diferente.</p></div>
                </div>
            </div>
        </div>
        
        <div id="aggregateContainer" class="hidden">
            <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-cyan-400">Análise de Cobertura</h2>
                    <p class="text-slate-400">Compare as pautas entre os veículos ou por assunto.</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex bg-slate-700/50 p-1 rounded-lg">
                        <button id="aggViewPortalBtn" class="agg-view-btn-active text-white px-3 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200">Visão por Portal</button>
                        <button id="aggViewTopicBtn" class="text-slate-300 hover:bg-slate-600/50 px-3 py-1.5 rounded-md text-sm font-semibold transition-colors duration-200">Visão por Assunto</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="refreshAggregateBtn" aria-label="Atualizar cobertura" class="text-slate-300 text-sm font-semibold p-2 rounded-lg transition-colors duration-200 bg-slate-700/50 hover:bg-slate-700 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-500"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                        </button>
                            <div id="aggregate-last-updated" class="text-sm text-slate-500 text-right flex-shrink-0"></div>
                    </div>
                </div>
            </div>
            <div id="portalsPanelContainerWrapper" class="relative group">
                 <button id="scrollPortalsLeft" class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-slate-800/80 backdrop-blur-sm hover:bg-slate-700/80 rounded-full p-2 transition-opacity opacity-0 group-hover:opacity-100 disabled:opacity-0 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <div id="portalsPanelContainer" class="portal-column-container"></div>
                <button id="scrollPortalsRight" class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-slate-800/80 backdrop-blur-sm hover:bg-slate-700/80 rounded-full p-2 transition-opacity opacity-0 group-hover:opacity-100 disabled:opacity-0 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                </button>
            </div>
            <div id="trendingTopicsContainerWrapper" class="hidden">
                 <div id="trendingTopicsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
            </div>
        </div>

    </div>
    
    <div id="rondasModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-4xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h2 class="text-lg font-bold text-cyan-400">Minhas Rondas</h2>
                <div class="flex items-center gap-4">
                    <button id="exportAllRondasBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold px-3 py-1.5 rounded-md flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                        Baixar Todas as Rondas
                    </button>
                    <div class="flex items-center">
                        <input type="text" id="newRondaInput" placeholder="Nome da nova ronda..." class="bg-slate-700 text-sm rounded-l-md px-2 py-1 focus:outline-none border border-slate-600">
                        <button id="addRondaBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white text-sm font-bold px-3 py-1 rounded-r-md">Criar</button>
                    </div>
                    <button id="closeRondasBtn" aria-label="Fechar Minhas Rondas"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
                </div>
            </header>
            <div class="flex-grow p-4 overflow-y-auto" id="rondasContent"></div>
        </div>
    </div>

    <div id="rondaInfoModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-lg">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h2 class="text-xl font-bold text-cyan-400">O que são as "Rondas"?</h2>
                </div>
                <p class="text-slate-300 mb-4">
                    As Rondas são pastas personalizadas para você organizar suas apurações. Elas ajudam a agrupar notícias sobre um mesmo tema, facilitando o seu trabalho.
                </p>
                <ul class="space-y-2 text-sm text-slate-400 list-disc list-inside">
                    <li><b>Crie Rondas</b> para cada pauta que estiver cobrindo.</li>
                    <li><b>Salve notícias</b> de qualquer feed diretamente em uma Ronda.</li>
                    <li><b>Adicione anotações</b> a cada matéria salva para registrar insights.</li>
                    <li><b>Exporte para Excel</b> para usar os dados em suas planilhas e análises.</li>
                </ul>
                <div class="mt-6 flex justify-end">
                    <button id="closeRondaInfoBtn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-semibold rounded-lg px-5 py-2 transition-colors duration-300">Entendi!</button>
                </div>
            </div>
        </div>
    </div>

    <div id="topicDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <h2 id="topicDetailTitle" class="text-lg font-bold text-cyan-400 truncate pr-4">Detalhes do Assunto</h2>
                <button id="closeTopicDetailModalBtn" aria-label="Fechar">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <div class="flex-grow p-4 overflow-y-auto" id="topicDetailContent">
                </div>
        </div>
    </div>


    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-transform duration-300"><p id="toastMessage"></p></div>
    <button id="backToTopBtn" aria-label="Voltar ao topo" class="hidden fixed bottom-5 right-5 bg-cyan-500 hover:bg-cyan-600 text-white p-3 rounded-full shadow-lg opacity-0 transform translate-y-20"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></svg></button>
    
    <button id="helpButton" aria-label="Ajuda e Guia de Uso" class="fixed bottom-5 left-5 bg-slate-600 hover:bg-slate-500 text-white p-3 rounded-full shadow-lg z-40 transition-transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
    </button>
    
    <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl border border-slate-700 shadow-lg w-full max-w-3xl max-h-[90vh] flex flex-col">
            <header class="flex items-center justify-between p-4 border-b border-slate-700 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <h2 class="text-xl font-bold text-cyan-400">Guia de Uso da Ferramenta</h2>
                </div>
                <button id="closeHelpModalBtn" aria-label="Fechar Ajuda">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </header>
            <div class="flex-grow p-6 overflow-y-auto space-y-6 text-slate-300">
            </div>
        </div>
    </div>

<script>
    // =================================================================================
    // CÓDIGO PRO - Versão com UI Colorida e Correções
    // =================================================================================

    // --- DOM ELEMENTS ---
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const buttonText = document.getElementById('buttonText');
    const lastUpdatedElement = document.getElementById('lastUpdated');
    const refreshButton = document.getElementById('refreshButton');
    const backToTopBtn = document.getElementById('backToTopBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const searchBarWrapper = document.getElementById('searchBarWrapper');
    const radarContainer = document.getElementById('radarContainer');
    const aggregateContainer = document.getElementById('aggregateContainer');
    const viewFilterRadar = document.getElementById('viewFilterRadar');
    const viewFilterForYou = document.getElementById('viewFilterForYou');
    const viewFilterAggregate = document.getElementById('viewFilterAggregate');
    const dateFilterContainer = document.getElementById('dateFilterContainer');
    const dateFilterToday = document.getElementById('dateFilterToday');
    const dateFilterLastWeek = document.getElementById('dateFilterLastWeek');
    const mediaFilterDropdown = document.getElementById('mediaFilterDropdown');
    const mediaFilterButton = document.getElementById('mediaFilterButton');
    const mediaDropdownMenu = document.getElementById('mediaDropdownMenu');
    const currentMediaLabel = document.getElementById('currentMediaLabel');
    const mediaDropdownIcon = document.getElementById('mediaDropdownIcon');
    const resultsContainer = document.getElementById('resultsContainer');
    const messageState = document.getElementById('messageState');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const categoriesContainer = document.getElementById('categoriesContainer');
    const contentCounter = document.getElementById('contentCounter');
    const clearFollowedBtn = document.getElementById('clearFollowedBtn');
    const rondasModal = document.getElementById('rondasModal');
    const closeRondasBtn = document.getElementById('closeRondasBtn');
    const rondasBtn = document.getElementById('rondasBtn');
    const rondaCountBadge = document.getElementById('rondaCountBadge');
    const newRondaInput = document.getElementById('newRondaInput');
    const addRondaBtn = document.getElementById('addRondaBtn');
    const rondasContent = document.getElementById('rondasContent');
    const portalsPanelContainerWrapper = document.getElementById('portalsPanelContainerWrapper');
    const trendingTopicsContainerWrapper = document.getElementById('trendingTopicsContainerWrapper');
    const portalsPanelContainer = document.getElementById('portalsPanelContainer');
    const trendingTopicsContainer = document.getElementById('trendingTopicsContainer');
    const aggregateLastUpdated = document.getElementById('aggregate-last-updated');
    const aggViewPortalBtn = document.getElementById('aggViewPortalBtn');
    const aggViewTopicBtn = document.getElementById('aggViewTopicBtn');
    const refreshAggregateBtn = document.getElementById('refreshAggregateBtn');
    const rondaInfoModal = document.getElementById('rondaInfoModal');
    const closeRondaInfoBtn = document.getElementById('closeRondaInfoBtn');
    const welcomeBanner = document.getElementById('welcomeBanner');
    const closeWelcomeBannerBtn = document.getElementById('closeWelcomeBannerBtn');
    const exportAllRondasBtn = document.getElementById('exportAllRondasBtn');
    const helpButton = document.getElementById('helpButton');
    const helpModal = document.getElementById('helpModal');
    const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
    const topicDetailModal = document.getElementById('topicDetailModal');
    const topicDetailTitle = document.getElementById('topicDetailTitle');
    const topicDetailContent = document.getElementById('topicDetailContent');
    const closeTopicDetailModalBtn = document.getElementById('closeTopicDetailModalBtn');
    const scrollPortalsLeft = document.getElementById('scrollPortalsLeft');
    const scrollPortalsRight = document.getElementById('scrollPortalsRight');

    // --- APP STATE --- 
    let currentAppView = 'radar';
    let currentRadarView = 'geral';
    let currentDateFilter = 'hoje';
    let currentMediaFilter = 'todos';
    let masterNewsCache = [];
    let rondas = [];
    let followedTopics = [];
    let currentPage = 1;
    const itemsPerPage = 20;
    let isLoadingMore = false;
    let currentCategorySearch = null;
    let currentAggregateView = 'portal';
    let newsHoldingPen = [];
    let trendingTopicsDataMap = new Map();

    // --- CONSTANTS & CONFIGS ---
    const mainCategories = ['Política', 'Economia', 'Mundo', 'Cidades', 'Saúde', 'Educação', 'Ciência', 'Meio Ambiente', 'Esportes', 'Cultura', 'Entretenimento', 'Viagem', 'Gastronomia', 'Carros'];
    const MEDIA_FORMATS = {
        'todos': { label: 'Todos', emoji: '' },
        'texto': { label: 'Notícia', emoji: '📝' },
        'video': { label: 'Vídeo', emoji: '▶️' },
        'podcast': { label: 'Podcast', emoji: '🎙️' },
        'imagem': { label: 'Imagem/Galeria', emoji: '🖼️' }
    };
    const categoryColorMap = {
        'Política': { border: 'border-blue-500', tagBg: 'bg-blue-500/10', tagText: 'text-blue-400' },
        'Economia': { border: 'border-emerald-500', tagBg: 'bg-emerald-500/10', tagText: 'text-emerald-400' },
        'Mundo': { border: 'border-sky-500', tagBg: 'bg-sky-500/10', tagText: 'text-sky-400' },
        'Cidades': { border: 'border-orange-500', tagBg: 'bg-orange-500/10', tagText: 'text-orange-400' },
        'Saúde': { border: 'border-red-500', tagBg: 'bg-red-500/10', tagText: 'text-red-400' },
        'Educação': { border: 'border-indigo-500', tagBg: 'bg-indigo-500/10', tagText: 'text-indigo-400' },
        'Ciência': { border: 'border-purple-500', tagBg: 'bg-purple-500/10', tagText: 'text-purple-400' },
        'Meio Ambiente': { border: 'border-green-500', tagBg: 'bg-green-500/10', tagText: 'text-green-400' },
        'Esportes': { border: 'border-lime-500', tagBg: 'bg-lime-500/10', tagText: 'text-lime-400' },
        'Cultura': { border: 'border-rose-500', tagBg: 'bg-rose-500/10', tagText: 'text-rose-400' },
        'Entretenimento': { border: 'border-pink-500', tagBg: 'bg-pink-500/10', tagText: 'text-pink-400' },
        'Viagem': { border: 'border-teal-500', tagBg: 'bg-teal-500/10', tagText: 'text-teal-400' },
        'Gastronomia': { border: 'border-amber-500', tagBg: 'bg-amber-500/10', tagText: 'text-amber-400' },
        'Carros': { border: 'border-slate-500', tagBg: 'bg-slate-500/10', tagText: 'text-slate-400' },
        'Outros': { border: 'border-gray-500', tagBg: 'bg-gray-500/10', tagText: 'text-gray-400' },
        'Todas': { border: 'border-cyan-500', tagBg: 'bg-cyan-500/10', tagText: 'text-cyan-400' }
    };
    const PORTAL_LOGOS = { "G1": "g1.globo.com", "UOL": "uol.com.br", "Folha": "folha.uol.com.br", "Estadão": "estadao.com.br", "Poder360": "poder360.com.br", "CNN": "cnnbrasil.com.br", "Metrópoles": "metropoles.com", "GE": "ge.globo.com", "Valor": "valor.globo.com", "Terra": "terra.com.br" };
    
    // --- FUNÇÕES DE ANÁLISE DE CONTEÚDO E UTILIDADE ---
    function extractEntities(title) { const words = title.split(' '); const entities = words.filter((word, index) => index > 0 && word.length > 3 && word[0] === word[0].toUpperCase() && isNaN(word)); return [...new Set(entities)]; }
    function determineMediaType(title, url) { const urlLower = url.toLowerCase(); const titleLower = title.toLowerCase(); if (titleLower.includes('galeria') || titleLower.includes('fotos') || titleLower.includes('imagens') || titleLower.includes('infográfico')) return 'imagem'; if (titleLower.includes('vídeo') || titleLower.includes('assista') || titleLower.includes('live') || titleLower.includes('ao vivo') || titleLower.includes('tv')) return 'video'; if (titleLower.includes('podcast') || titleLower.includes('áudio') || titleLower.includes('ouça') || titleLower.includes('cast')) return 'podcast'; if (urlLower.includes('youtube.com') || urlLower.includes('vimeo.com') || urlLower.includes('/videos/') || urlLower.includes('/tv/') || urlLower.includes('globo.com/videos/')) return 'video'; if (urlLower.includes('soundcloud.com') || urlLower.includes('/podcasts/') || urlLower.includes('g1.globo.com/podcast')) return 'podcast'; return 'texto'; }
    function getRelativeDate(timestamp) {
        const now = new Date();
        const articleDate = new Date(timestamp);
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const articleDay = new Date(articleDate.getFullYear(), articleDate.getMonth(), articleDate.getDate());
        if (articleDay.getTime() === today.getTime()) { return "Hoje"; }
        if (articleDay.getTime() === yesterday.getTime()) { return "Ontem"; }
        return articleDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
    }

    // --- FUNÇÃO DE FETCH ---
    async function fetchFromGoogleNewsAPI(query = null) {
        // Se o usuário buscar por algo, avisamos que a busca está desativada nesta versão.
        if (query) {
            console.log("A busca manual está desativada na versão com Google Sheets.");
            showToast("A busca está desativada. Exibindo histórico geral.");
        }

        // ▼▼▼ URL DO SEU ROBÔ (APP DA WEB) ▼▼▼
        const roboApiUrl = "https://script.google.com/macros/s/AKfycbzecqRjk8trLq2EZ6h-jZJN8C6t92PbWbhSfxdzcLxT7HSUZgTnn5nO1on1Y3uf4sd8kw/exec";

        try {
            const response = await fetch(roboApiUrl);
            if (!response.ok) {
                console.error("Erro ao contatar o robô. Status: " + response.status);
                document.getElementById('apiError').textContent = "Erro ao carregar dados. O robô pode estar offline.";
                return [];
            }
            const data = await response.json();
            // Os dados já vêm no formato que o resto do código espera.
            return data;
        } catch (error) {
            console.error("Falha grave na comunicação com a API: ", error);
            document.getElementById('apiError').textContent = "Falha de conexão com a API do robô.";
            return [];
        }
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO ---
    function getMediaIconAndColor(mediaType) { return MEDIA_FORMATS[mediaType] || MEDIA_FORMATS['texto']; }
    function updateMediaDropdown(filterKey) { const mediaInfo = getMediaIconAndColor(filterKey); currentMediaLabel.textContent = `Mídia: ${mediaInfo.label} ${mediaInfo.emoji}`; mediaDropdownMenu.querySelectorAll('button').forEach(btn => btn.classList.remove('media-dropdown-active')); const activeBtn = mediaDropdownMenu.querySelector(`[data-media-key="${filterKey}"]`); if (activeBtn) activeBtn.classList.add('media-dropdown-active'); }
    const applyMediaFilter = (items, filterKey) => (filterKey === 'todos' ? items : items.filter(item => item.mediaType === filterKey));
    
    function renderRadarResults(append = false) { 
        if (!append) { resultsContainer.innerHTML = ''; currentPage = 1; } 
        
        let filteredNews = masterNewsCache;
        filteredNews = applyDateFilter(filteredNews, currentDateFilter);
        filteredNews = applyMediaFilter(filteredNews, currentMediaFilter);

        if (currentCategorySearch && currentCategorySearch !== 'Todas') {
            filteredNews = filteredNews.filter(news => news.category === currentCategorySearch);
        }

        if (currentRadarView === 'paraSi' && currentAppView === 'radar') { 
            if (followedTopics.length === 0) { 
                messageState.classList.remove('hidden'); 
                messageTitle.textContent = 'Adicione seus Tópicos Favoritos!'; 
                messageText.textContent = 'Para ver o feed "Meu Radar", clique nos editoriais abaixo para seguir.'; 
                contentCounter.textContent = ''; 
                resultsContainer.innerHTML = ''; 
                return; 
            } 
            filteredNews = filteredNews.filter(news => followedTopics.some(followed => followed.topic === news.category)); 
            const getPriority = (category) => { const followed = followedTopics.find(t => t.topic === category); return followed ? followed.priority : 0; }; 
            filteredNews.sort((a, b) => getPriority(b.category) - getPriority(a.category)); 
        } 

        const totalItems = filteredNews.length; 
        const startIndex = (currentPage - 1) * itemsPerPage; 
        const endIndex = startIndex + itemsPerPage; 
        const paginatedItems = filteredNews.slice(startIndex, endIndex); 
        
        if (paginatedItems.length === 0 && currentPage === 1) { 
            messageState.classList.remove('hidden'); 
            messageTitle.textContent = 'Nenhuma notícia encontrada.'; 
            messageText.textContent = 'Tente um termo diferente ou ajuste os filtros.'; 
            contentCounter.textContent = ''; 
            return; 
        } 
        
        messageState.classList.add('hidden'); 
        
        paginatedItems.forEach((item, index) => { 
            const card = createGoogleNewsCard(item); 
            if (currentPage === 1 && index === 0 && !searchInput.value.trim() && currentRadarView === 'geral' && currentAppView === 'radar') { 
                card.classList.add('md:col-span-2', 'lg:col-span-2', 'lead-story'); 
            } 
            resultsContainer.appendChild(card); 
        }); 
        
        contentCounter.textContent = `Exibindo ${resultsContainer.children.length} de ${totalItems} notícias.`; 
        isLoadingMore = false; 
    }
    
    function createGoogleNewsCard(news) {
        const newsElement = document.createElement('article');
        const primaryCategory = news.category === 'Geral' ? 'Outros' : news.category; 
        const colors = categoryColorMap[primaryCategory] || categoryColorMap['Outros'];
        
        const newsDateTime = new Date(news.timestamp);
        const fullDateTime = `${newsDateTime.toLocaleDateString('pt-BR')} ${newsDateTime.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
        const logoUrl = `https://www.google.com/s2/favicons?domain=${news.sourceDomain}&sz=64`;
        const fallbackSvg = `<div class='flex-shrink-0 w-6 h-6 rounded-md bg-slate-700 flex items-center justify-center'><svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 text-slate-400' fill='none' viewBox='0 0 24 24' stroke='currentColor' stroke-width='2'><path stroke-linecap='round' stroke-linejoin='round' d='M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 12h6M7 8h6' /></svg></div>`;
        const saveButtonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-400 hover:text-cyan-500 save-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`;
        let finalTitle = news.title;
        const searchTerm = searchInput.value.trim().split('fonte:')[0].trim();
        if (searchTerm) { const regex = new RegExp(`(${searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi'); finalTitle = finalTitle.replace(regex, `<span class="highlight">$1</span>`); }
        const mediaInfo = getMediaIconAndColor(news.mediaType);
        const mediaTag = `<span class="text-lg text-slate-300 ml-1 has-tooltip" data-tooltip="${mediaInfo.label}">${mediaInfo.emoji}</span>`;
        const entities = extractEntities(news.title);
        const entitiesHTML = entities.length > 0 ? `<div class="flex flex-wrap gap-1 mt-3">${entities.map(e => `<span class="entity-tag">${e}</span>`).join('')}</div>` : '';
        
        const borderColorClass = colors.border;
        const categoryHTML = `<span class="text-xs font-medium ${colors.tagBg} ${colors.tagText} px-2 py-1 rounded-full">${primaryCategory}</span>`;

        newsElement.className = `bg-slate-800 border-l-4 ${borderColorClass} rounded-r-lg p-5 shadow-lg flex flex-col transform hover:scale-[1.01] transition-transform duration-300`;
        newsElement.innerHTML = `<div class="flex justify-between items-start gap-2"><a href="${news.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 min-w-0"><img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-6 h-6 rounded-md" onerror="this.outerHTML = \`${fallbackSvg}\`"><p class="font-semibold text-slate-100 truncate" title="${news.sourceName}">${news.sourceName}</p></a><button class="add-to-ronda-btn" data-url="${news.url}" aria-label="Adicionar à Ronda">${saveButtonIcon}</button></div><div><a href="${news.url}" target="_blank" rel="noopener noreferrer"><p class="text-slate-300 font-semibold leading-relaxed my-2 news-title">${finalTitle} ${mediaTag}</p></a>${entitiesHTML}</div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50">${categoryHTML}<span class="text-xs text-slate-500">${fullDateTime}</span></div>`;
        return newsElement;
    }

    // --- LÓGICA DE INTERFACE E UTILITÁRIOS ---
    function handleDateFilterChange(filterKey, buttonElement) { currentDateFilter = filterKey; dateFilterContainer.querySelectorAll('button').forEach(btn => { btn.classList.remove('date-filter-active'); btn.setAttribute('aria-pressed', 'false'); btn.classList.add('text-slate-300', 'hover:bg-slate-700'); }); buttonElement.classList.add('date-filter-active'); buttonElement.classList.remove('text-slate-300', 'hover:bg-slate-700'); buttonElement.setAttribute('aria-pressed', 'true'); renderRadarResults(); }
    const applyDateFilter = (items, filterKey) => { const today = new Date(); today.setHours(0, 0, 0, 0); const filterFn = { 'hoje': (item) => new Date(item.timestamp) >= today, 'ultima_semana': (item) => { const sevenDaysAgo = new Date(today); sevenDaysAgo.setDate(today.getDate() - 7); const itemDate = new Date(item.timestamp); return itemDate >= sevenDaysAgo; } }; return items.filter(filterFn[filterKey] || (() => true)); };
    
    function renderCategories() {
        categoriesContainer.innerHTML = '';
        const tabsContainer = document.createElement('div');
        tabsContainer.className = 'flex items-center gap-4 overflow-x-auto category-tabs-container pt-2';
        
        const createTab = (category) => {
            const tabButton = document.createElement('button');
            const colors = categoryColorMap[category] || categoryColorMap['Outros'];
            let tabClasses = 'category-tab text-sm font-semibold py-2 px-1 whitespace-nowrap transition-colors duration-200';

            if (currentRadarView === 'paraSi') {
                const followedTopic = followedTopics.find(t => t.topic === category);
                if (followedTopic) {
                    tabClasses += followedTopic.priority === 1 ? ' category-priority-text' : ' category-followed-text';
                } else {
                    tabClasses += ' text-slate-400 hover:text-white';
                }
            } else { // 'geral' view
                const isActive = (currentCategorySearch === category) || (category === 'Todas' && currentCategorySearch === null);
                if (isActive) {
                    tabClasses += ` ${colors.border.replace('border-', 'border-b-')} text-slate-100`;
                } else {
                    tabClasses += ` ${colors.tagText} hover:text-slate-200`;
                }
            }
            
            tabButton.className = tabClasses;
            tabButton.textContent = category;
            tabButton.dataset.category = category;
            
            tabButton.onclick = () => {
                if (currentRadarView === 'paraSi') {
                    const topicIndex = followedTopics.findIndex(t => t.topic === category);
                    if (topicIndex > -1) {
                        if (followedTopics[topicIndex].priority === 0) {
                            followedTopics[topicIndex].priority = 1; showToast(`"${category}" definido como prioridade!`);
                        } else {
                            followedTopics.splice(topicIndex, 1); showToast(`Deixou de seguir "${category}"`);
                        }
                    } else {
                        followedTopics.push({ topic: category, priority: 0 }); showToast(`Agora segue "${category}"`);
                    }
                    localStorage.setItem('followedTopics', JSON.stringify(followedTopics));
                    renderCategories();
                    renderRadarResults();
                } else {
                    handleCategoryFilter(category);
                }
            };
            return tabButton;
        };
        
        tabsContainer.appendChild(createTab('Todas'));
        mainCategories.forEach(category => tabsContainer.appendChild(createTab(category)));
        categoriesContainer.appendChild(tabsContainer);

        clearFollowedBtn.classList.toggle('hidden', !(currentRadarView === 'paraSi' && followedTopics.length > 0));
    }

    function handleCategoryFilter(category) {
        currentCategorySearch = (category === 'Todas' || category === null) ? null : category;
        renderCategories(); 
        renderRadarResults();
    }
    
    function showToast(message) { toastMessage.textContent = message; toast.classList.remove('opacity-0', 'translate-y-20'); toast.classList.add('opacity-100', 'translate-y-0'); setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-20'); toast.classList.remove('opacity-100', 'translate-y-0'); }, 3000); }
    function setLoading(isLoading, isInitialLoad = true) { const refreshIcon = refreshButton.querySelector('svg'); if (isLoading) { searchButton.disabled = true; buttonText.textContent = "Buscando..."; if (refreshIcon) refreshIcon.classList.add('animate-spin'); if (isInitialLoad) { messageState.classList.add('hidden'); resultsContainer.innerHTML = Array(6).fill(`<div class="bg-slate-800 border-l-4 border-slate-700 rounded-r-lg p-5 shadow-lg flex flex-col gap-4 animate-pulse"><div class="flex justify-between items-start"><div class="flex items-center gap-3 w-1/2"><div class="w-6 h-6 rounded-md bg-slate-700"></div><div class="h-4 bg-slate-700 rounded w-full"></div></div><div class="h-6 w-12 bg-slate-700 rounded-full"></div></div><div><div class="h-5 bg-slate-700 rounded w-full mb-2"></div><div class="h-5 bg-slate-700 rounded w-3/4"></div></div><div class="flex items-center justify-between text-sm mt-auto pt-4 border-t border-slate-700/50"><div class="h-5 w-20 bg-slate-700 rounded-full"></div><div class="h-4 w-24 bg-slate-700 rounded"></div></div></div>`).join(''); } } else { searchButton.disabled = false; buttonText.textContent = "Buscar"; if (refreshIcon) refreshIcon.classList.remove('animate-spin'); } }
    async function loadInitialContent(isAutoRefresh = false) { 
        if (!isAutoRefresh) { setLoading(true, true); } 
        let fetchedNews = await fetchFromGoogleNewsAPI(); 
        masterNewsCache = fetchedNews; 
        if (!isAutoRefresh) { setLoading(false, true); } 
        renderRadarResults(); 
        updateTimestamp(); 
    }
    
    async function handleSearch(queryValue, category = null) { 
        // A busca no frontend é desabilitada, pois a API agora traz todos os dados.
        // A busca teria que ser implementada no lado do robô (Apps Script).
        showToast("A busca está temporariamente desativada.");
        // Apenas recarregamos os dados gerais.
        loadInitialContent();
    }
    
    function handleMediaFilterChange(filterKey) { currentMediaFilter = filterKey; updateMediaDropdown(filterKey); mediaDropdownMenu.classList.add('hidden'); mediaFilterButton.setAttribute('aria-expanded', 'false'); mediaDropdownIcon.classList.remove('rotate-180'); renderRadarResults(); }
    function updateTimestamp() { const timeString = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); lastUpdatedElement.innerHTML = `<span>Dados atualizados às ${timeString}</span> <span class="text-slate-500/70">(Robô atualiza a cada 30 min)</span>`; }
    function updateClearSearchButton() { clearSearchBtn.classList.toggle('hidden', searchInput.value.trim().length === 0); }
    function handleScroll() { if (currentAppView === 'radar' && (window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !isLoadingMore) { let listForCounting = masterNewsCache; listForCounting = applyDateFilter(listForCounting, currentDateFilter); const totalItems = applyMediaFilter(listForCounting, currentMediaFilter).length; if (resultsContainer.children.length < totalItems) { isLoadingMore = true; currentPage++; renderRadarResults(true); } } if (window.scrollY > 300) { backToTopBtn.classList.remove('hidden', 'opacity-0', 'translate-y-20'); backToTopBtn.classList.add('opacity-100', 'translate-y-0'); } else { backToTopBtn.classList.add('opacity-0', 'translate-y-20'); setTimeout(() => backToTopBtn.classList.add('hidden'), 300); } }
    
    function setView(view) { 
        currentAppView = view; 
        [viewFilterRadar, viewFilterForYou, viewFilterAggregate].forEach(btn => { 
            btn.classList.remove('view-filter-active'); 
            btn.classList.add('text-slate-300', 'hover:bg-slate-600/50'); 
            btn.setAttribute('aria-pressed', 'false'); 
        }); 
        
        const secondaryFilters = document.getElementById('secondaryFilters'); 
        const categoriesSection = document.querySelector('#radarContainer .mb-8'); 
        categoriesSection.classList.remove('hidden'); 
        searchBarWrapper.style.display = 'flex'; 
        secondaryFilters.style.display = 'flex'; 
        dateFilterContainer.style.display = 'flex'; 
        
        if (view === 'radar') { 
            radarContainer.classList.remove('hidden'); 
            aggregateContainer.classList.add('hidden'); 
            if (currentRadarView === 'geral') { 
                viewFilterRadar.classList.add('view-filter-active'); 
                viewFilterRadar.setAttribute('aria-pressed', 'true'); 
            } else { 
                viewFilterForYou.classList.add('view-filter-active'); 
                viewFilterForYou.setAttribute('aria-pressed', 'true'); 
            } 
            handleCategoryFilter(currentCategorySearch);
        } else if (view === 'aggregate') { 
            radarContainer.classList.add('hidden'); 
            aggregateContainer.classList.remove('hidden'); 
            viewFilterAggregate.classList.add('view-filter-active'); 
            viewFilterAggregate.setAttribute('aria-pressed', 'true'); 
            searchBarWrapper.style.display = 'none'; 
            secondaryFilters.style.display = 'none'; 
            categoriesSection.classList.add('hidden'); 
            setupAggregateView(); 
        } 
        
        renderCategories(); 
        renderRadarResults(); 
    }

    function renderRondas() { rondasContent.innerHTML = ''; rondaCountBadge.textContent = rondas.length; if (rondas.length === 0) { rondasContent.innerHTML = `<p class="text-center text-slate-400">Crie sua primeira ronda para organizar suas pautas.</p>`; return; } rondas.forEach((ronda, index) => { const rondaElement = document.createElement('div'); rondaElement.className = 'bg-slate-700/50 rounded-lg p-4 mb-4'; rondaElement.innerHTML = `<div class="flex justify-between items-center mb-3"><h3 class="text-base font-bold text-cyan-400">${ronda.name} (${ronda.news.length})</h3><div><button class="export-xlsx-btn text-xs text-cyan-400 hover:underline mr-4" data-index="${index}">Exportar Ronda</button><button class="delete-ronda-btn text-xs text-red-400 hover:text-red-300" data-index="${index}">Excluir</button></div></div><div class="space-y-2 max-h-60 overflow-y-auto pr-2" id="ronda-list-${index}">${ronda.news.length > 0 ? ronda.news.map((item, itemIndex) => `<div class="bg-slate-800 p-2 rounded-md"><div class="flex justify-between items-start"><a href="${item.url}" target="_blank" class="text-sm text-slate-300 hover:underline flex-1 truncate pr-2" title="${item.title}">${item.title}</a><button class="remove-from-ronda-btn flex-shrink-0" data-ronda-index="${index}" data-item-index="${itemIndex}" aria-label="Remover"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-red-500 hover:text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div><textarea class="note-textarea w-full bg-slate-700 text-slate-300 text-xs p-1 mt-2 rounded border border-slate-600 focus:outline-none focus:ring-1 focus:ring-cyan-500" rows="1" placeholder="Adicionar anotação..." data-ronda-index="${index}" data-item-index="${itemIndex}">${item.note || ''}</textarea></div>`).join('') : '<p class="text-xs text-slate-500 text-center">Nenhuma notícia nesta ronda.</p>'}</div>`; rondasContent.appendChild(rondaElement); }); }
    function saveRondas() { localStorage.setItem('rondas', JSON.stringify(rondas)); }
    function exportToXLSX(rondaIndex) { const ronda = rondas[rondaIndex]; if (!ronda || ronda.news.length === 0) { showToast('Ronda vazia.'); return; } const dataToExport = ronda.news.map(item => ({ 'Título': item.title, 'URL': item.url, 'Fonte': item.sourceName, 'Data': new Date(item.timestamp).toLocaleString('pt-BR'), 'Anotação': item.note || '' })); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, "Ronda"); XLSX.writeFile(workbook, `${ronda.name.replace(/\s+/g, '_')}.xlsx`); showToast(`Ronda "${ronda.name}" exportada!`); }
    function exportAllRondasToXLSX() { if (rondas.length === 0) { showToast("Nenhuma ronda para exportar."); return; } const workbook = XLSX.utils.book_new(); rondas.forEach(ronda => { if (ronda.news.length > 0) { const dataToExport = ronda.news.map(item => ({ 'Título': item.title, 'URL': item.url, 'Fonte': item.sourceName, 'Data': new Date(item.timestamp).toLocaleString('pt-BR'), 'Anotação': item.note || '' })); const worksheet = XLSX.utils.json_to_sheet(dataToExport); const sheetName = ronda.name.replace(/[\\/*?\[\]]/g, '').substring(0, 31); XLSX.utils.book_append_sheet(workbook, worksheet, sheetName); } }); if (workbook.SheetNames.length === 0) { showToast("Todas as rondas estão vazias."); return; } XLSX.writeFile(workbook, `Minhas_Rondas_${new Date().toISOString().split('T')[0]}.xlsx`); }
    
    // --- LÓGICA DA "COBERTURA DA MÍDIA" ---
    async function setupAggregateView() { if (currentAggregateView === 'portal') { await renderPortalsPanel(); } else { renderTrendingTopicsView(); } const updateTime = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }); aggregateLastUpdated.innerHTML = `Verificado às: <strong>${updateTime}</strong>`; }
    async function renderPortalsPanel() {
        portalsPanelContainer.innerHTML = `<p class="text-center text-slate-400 col-span-full animate-pulse">Buscando manchetes...</p>`;
        // Na nova versão, os dados já estão no masterNewsCache, não precisamos buscar de novo.
        const portalData = masterNewsCache.reduce((acc, news) => {
            const portalName = Object.keys(PORTAL_LOGOS).find(key => PORTAL_LOGOS[key] === news.sourceDomain);
            if (portalName) {
                if (!acc[portalName]) acc[portalName] = [];
                acc[portalName].push(news);
            }
            return acc;
        }, {});

        portalsPanelContainer.innerHTML = '';
        for (const portal in portalData) {
            const portalNews = portalData[portal].slice(0, 10); // Limita a 10 notícias por portal
            if (portalNews.length === 0) continue;
            const logo = `https://www.google.com/s2/favicons?domain=${portalNews[0].sourceDomain}&sz=32`;
            const itemsHTML = portalNews.map((item, index) => {
                const isLead = index === 0;
                const time = new Date(item.timestamp).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                return `<a href="${item.url}" target="_blank" rel="noopener noreferrer" class="block border-t border-slate-700/50 pt-2 mt-2 hover:bg-slate-700/50 p-1 rounded-md transition-colors"><p class="${isLead ? 'font-bold text-cyan-400 text-base' : 'text-slate-300 text-sm'}">${item.title}</p><p class="text-xs text-slate-500 font-mono mt-1">${time}</p></a>`;
            }).join('');
            const column = document.createElement('div');
            column.className = 'portal-column bg-slate-800/60 border border-slate-700 rounded-lg p-4 flex flex-col h-full';
            column.innerHTML = `<div class="flex items-center gap-2 mb-4 flex-shrink-0"><img src="${logo}" class="w-5 h-5 rounded-full" alt="Logo ${portal}"/><h3 class="font-bold text-lg text-slate-100">${portal}</h3></div><div class="flex-grow overflow-y-auto pr-2 portal-news-list">${itemsHTML}</div>`;
            portalsPanelContainer.appendChild(column);
        }
        setTimeout(updatePortalScrollArrows, 100);
    }
    
    function renderTrendingTopicsView() {
        const newsItems = masterNewsCache;
        trendingTopicsDataMap.clear();
        if (newsItems.length === 0) { trendingTopicsContainer.innerHTML = `<p class="col-span-full text-center text-slate-400">Aguardando notícias...</p>`; return; }
        const stopWords = new Set(['a', 'o', 'e', 'é', 'de', 'do', 'da', 'dos', 'das', 'em', 'no', 'na', 'um', 'uma', 'com', 'por', 'para', 'se', 'que', 'como', 'são', 'mas', 'foi', 'ser', 'tem', 'já', 'diz', 'sobre', 'após', 'ter', 'pode', 'faz', 'novo', 'nova']);
        const topicData = new Map();
        newsItems.forEach(item => {
            const cleanTitle = item.title.split(' - ')[0].toLowerCase().replace(/[^\w\s]/g, '');
            const words = cleanTitle.split(/\s+/);
            const significantWords = [...new Set(words.filter(word => word.length > 3 && isNaN(word) && !stopWords.has(word)))];
            const entities = extractEntities(item.title).map(e => e.toLowerCase());
            const topicKeywords = [...new Set([...entities, ...significantWords])];
            if (topicKeywords.length > 0) {
                const topicKey = topicKeywords.slice(0, 2).join(' '); 
                if (!topicData.has(topicKey)) {
                    topicData.set(topicKey, { count: 0, articles: [], fullTopics: new Set() });
                }
                const data = topicData.get(topicKey);
                data.count++;
                data.articles.push(item);
                data.fullTopics.add(item.title.split(' - ')[0]);
            }
        });
        const filteredTopics = Array.from(topicData.entries()).filter(([key, value]) => value.count > 1 && value.articles.length > 1);
        const topicsWithTimestamp = filteredTopics.map(([key, data]) => {
            const mostRecentTimestamp = Math.max(...data.articles.map(a => a.timestamp));
            return { key, data, mostRecentTimestamp };
        });
        const sortedTopics = topicsWithTimestamp.sort((a, b) => b.mostRecentTimestamp - a.mostRecentTimestamp);
        const top50Topics = sortedTopics.slice(0, 50);
        trendingTopicsContainer.innerHTML = '';
        if (top50Topics.length === 0) { trendingTopicsContainer.innerHTML = `<p class="col-span-full text-center text-slate-400">Não há assuntos com cobertura suficiente no momento.</p>`; return; }
        top50Topics.forEach(({ key, data }) => {
            trendingTopicsDataMap.set(key, data.articles);
            const representativeTitle = [...data.fullTopics][0];
            const uniquePortals = new Map();
            data.articles.forEach(article => {
                const portalKey = Object.keys(PORTAL_LOGOS).find(pKey => PORTAL_LOGOS[pKey] === article.sourceDomain);
                if (portalKey && !uniquePortals.has(portalKey)) {
                    uniquePortals.set(portalKey, { name: portalKey, domain: article.sourceDomain });
                }
            });
            if (uniquePortals.size < 2) return;
            const mostRecentTimestamp = Math.max(...data.articles.map(a => a.timestamp));
            const relativeDateString = getRelativeDate(mostRecentTimestamp);
            const logosHTML = [...uniquePortals.values()].map(p => `<img src="https://www.google.com/s2/favicons?domain=${p.domain}&sz=32" class="w-6 h-6 rounded-full -ml-2 border-2 border-slate-800" title="${p.name}">`).join('');
            const card = document.createElement('div');
            card.className = 'topic-card bg-slate-800/60 border border-slate-700 rounded-lg p-4 flex flex-col';
            card.dataset.topicKey = key;
            card.innerHTML = `<div class="flex-grow"><div class="flex justify-between items-center mb-2 gap-2"><span class="text-sm text-cyan-400 font-semibold">${data.count} Notícias</span><span class="text-xs font-semibold bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full">${relativeDateString}</span></div><h3 class="font-semibold text-slate-200 mt-1">${representativeTitle}</h3></div><div class="flex items-center justify-end pt-3 mt-3 border-t border-slate-700/50"><div class="flex flex-row-reverse">${logosHTML}</div></div>`;
            trendingTopicsContainer.appendChild(card);
        });
    }
    
    function updatePortalScrollArrows() { if (!portalsPanelContainer) return; const { scrollLeft, scrollWidth, clientWidth } = portalsPanelContainer; scrollPortalsLeft.disabled = scrollLeft <= 0; scrollPortalsRight.disabled = scrollLeft >= scrollWidth - clientWidth - 5; }
    async function refreshAggregateView() { if (currentAppView === 'aggregate') { const container = currentAggregateView === 'portal' ? portalsPanelContainerWrapper : trendingTopicsContainerWrapper; const icon = refreshAggregateBtn.querySelector('svg'); icon.classList.add('animate-spin'); container.style.opacity = '0.5'; await setupAggregateView(); container.style.opacity = '1'; icon.classList.remove('animate-spin'); showToast("Painel de cobertura atualizado!"); } }

    document.addEventListener('DOMContentLoaded', () => {
        const storedRondas = localStorage.getItem('rondas'); 
        if (storedRondas) { rondas = JSON.parse(storedRondas); }
        const storedTopics = localStorage.getItem('followedTopics'); if (storedTopics) { followedTopics = JSON.parse(storedTopics); }
        if (!localStorage.getItem('hasSeenWelcomeInfo')) { welcomeBanner.classList.remove('hidden'); setTimeout(() => { welcomeBanner.classList.add('hidden') }, 20000); }
        updateMediaDropdown(currentMediaFilter);
        loadInitialContent().then(() => setView(currentAppView));
        
        // O auto-refresh do frontend foi removido, pois agora os dados são sempre os mais recentes da planilha.
        // O botão de refresh manual continua funcionando para buscar os dados mais atuais do robô.

        mediaFilterButton.addEventListener('click', (e) => { e.stopPropagation(); const isExpanded = mediaFilterButton.getAttribute('aria-expanded') === 'true'; mediaFilterButton.setAttribute('aria-expanded', !isExpanded); mediaDropdownMenu.classList.toggle('hidden', isExpanded); mediaDropdownIcon.classList.toggle('rotate-180', !isExpanded); });
        mediaDropdownMenu.querySelectorAll('button').forEach(button => button.addEventListener('click', (e) => handleMediaFilterChange(e.currentTarget.getAttribute('data-media-key'))));
        document.addEventListener('click', (e) => { if (mediaFilterDropdown && !mediaFilterDropdown.contains(e.target)) { mediaDropdownMenu.classList.add('hidden'); mediaFilterButton.setAttribute('aria-expanded', 'false'); mediaDropdownIcon.classList.remove('rotate-180'); } });
        viewFilterRadar.addEventListener('click', () => { currentRadarView = 'geral'; setView('radar'); });
        viewFilterForYou.addEventListener('click', () => { currentRadarView = 'paraSi'; setView('radar'); });
        viewFilterAggregate.addEventListener('click', () => setView('aggregate'));
        searchButton.addEventListener('click', () => handleSearch(searchInput.value, null));
        searchInput.addEventListener('input', updateClearSearchButton);
        searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleSearch(searchInput.value, null); });
        clearSearchBtn.addEventListener('click', () => { searchInput.value = ''; updateClearSearchButton(); loadInitialContent(); });
        dateFilterToday.addEventListener('click', (e) => handleDateFilterChange('hoje', e.currentTarget));
        dateFilterLastWeek.addEventListener('click', (e) => handleDateFilterChange('ultima_semana', e.currentTarget));
        refreshButton.addEventListener('click', () => { setLoading(true, false); searchInput.value = ''; loadInitialContent(); });
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        clearFollowedBtn.addEventListener('click', () => { followedTopics = []; localStorage.removeItem('followedTopics'); renderCategories(); renderRadarResults(); showToast('Tópicos seguidos limpos.'); });
        window.addEventListener('scroll', handleScroll);
        rondasBtn.addEventListener('click', () => { if (!localStorage.getItem('hasSeenRondaInfo')) { rondaInfoModal.classList.remove('hidden'); } else { renderRondas(); rondasModal.classList.remove('hidden'); } });
        closeRondasBtn.addEventListener('click', () => rondasModal.classList.add('hidden'));
        addRondaBtn.addEventListener('click', () => { const name = newRondaInput.value.trim(); if (name) { rondas.push({ name: name, news: [] }); saveRondas(); renderRondas(); newRondaInput.value = ''; showToast(`Ronda "${name}" criada!`); } });
        rondasContent.addEventListener('click', (e) => { const deleteBtn = e.target.closest('.delete-ronda-btn'); if (deleteBtn) { const index = deleteBtn.dataset.index; if (confirm(`Excluir a ronda "${rondas[index].name}"?`)) { rondas.splice(index, 1); saveRondas(); renderRondas(); showToast(`Ronda excluída.`); } } const removeBtn = e.target.closest('.remove-from-ronda-btn'); if (removeBtn) { const { rondaIndex, itemIndex } = removeBtn.dataset; rondas[rondaIndex].news.splice(itemIndex, 1); saveRondas(); renderRondas(); showToast(`Notícia removida.`); } const exportBtn = e.target.closest('.export-xlsx-btn'); if (exportBtn) exportToXLSX(exportBtn.dataset.index); });
        rondasContent.addEventListener('change', (e) => { if (e.target.classList.contains('note-textarea')) { const { rondaIndex, itemIndex } = e.target.dataset; rondas[rondaIndex].news[itemIndex].note = e.target.value; saveRondas(); } });
        resultsContainer.addEventListener('click', (e) => { const saveButton = e.target.closest('.add-to-ronda-btn'); if (saveButton) { e.preventDefault(); const urlToSave = saveButton.dataset.url; const newsItem = masterNewsCache.find(item => item.url === urlToSave); if (!newsItem) return; if (rondas.length === 0) { showToast('Crie uma ronda primeiro!'); return; } const promptMsg = `Adicionar a qual ronda?\n${rondas.map((d, i) => `${i+1}: ${d.name}`).join('\n')}`; const choice = prompt(promptMsg); if (choice && rondas[choice-1]) { const ronda = rondas[choice-1]; if (ronda.news.some(n => n.url === newsItem.url)) { showToast('Notícia já está nesta ronda.'); return; } ronda.news.push(newsItem); saveRondas(); showToast(`Salvo em "${ronda.name}"!`); saveButton.querySelector('svg').classList.add('text-cyan-500'); } } });
        aggViewPortalBtn.addEventListener('click', () => { currentAggregateView = 'portal'; aggViewPortalBtn.classList.add('agg-view-btn-active'); aggViewTopicBtn.classList.remove('agg-view-btn-active'); portalsPanelContainerWrapper.classList.remove('hidden'); trendingTopicsContainerWrapper.classList.add('hidden'); setupAggregateView(); });
        aggViewTopicBtn.addEventListener('click', () => { currentAggregateView = 'topic'; aggViewTopicBtn.classList.add('agg-view-btn-active'); aggViewPortalBtn.classList.remove('agg-view-btn-active'); trendingTopicsContainerWrapper.classList.remove('hidden'); portalsPanelContainerWrapper.classList.add('hidden'); setupAggregateView(); });
        refreshAggregateBtn.addEventListener('click', () => refreshAggregateView());
        closeRondaInfoBtn.addEventListener('click', () => { localStorage.setItem('hasSeenRondaInfo', 'true'); rondaInfoModal.classList.add('hidden'); renderRondas(); rondasModal.classList.remove('hidden'); });
        closeWelcomeBannerBtn.addEventListener('click', () => { localStorage.setItem('hasSeenWelcomeInfo', 'true'); welcomeBanner.classList.add('hidden'); });
        exportAllRondasBtn.addEventListener('click', () => exportAllRondasToXLSX());
        helpButton.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpModalBtn.addEventListener('click', () => helpModal.classList.add('hidden'));
        helpModal.addEventListener('click', (e) => { if (e.target.id === 'helpModal') { helpModal.classList.add('hidden'); } });
        scrollPortalsLeft.addEventListener('click', () => portalsPanelContainer.scrollBy({ left: -350, behavior: 'smooth' }));
        scrollPortalsRight.addEventListener('click', () => portalsPanelContainer.scrollBy({ left: 350, behavior: 'smooth' }));
        portalsPanelContainer.addEventListener('scroll', updatePortalScrollArrows);
        trendingTopicsContainer.addEventListener('click', (e) => {
            const topicCard = e.target.closest('.topic-card');
            if (topicCard) {
                const topicKey = topicCard.dataset.topicKey;
                const articles = trendingTopicsDataMap.get(topicKey);
                if (articles) {
                    topicDetailTitle.textContent = articles[0].title.split(' - ')[0];
                    let contentHTML = '<div class="space-y-3">';
                    articles.forEach(article => {
                        const logoUrl = `https://www.google.com/s2/favicons?domain=${article.sourceDomain}&sz=32`;
                        contentHTML += `<a href="${article.url}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-3 bg-slate-700/50 hover:bg-slate-700 p-2 rounded-lg transition-colors"><img src="${logoUrl}" alt="Logo" class="flex-shrink-0 w-5 h-5 rounded-full"><div class="flex-1 min-w-0"><p class="text-sm text-slate-300 truncate font-semibold">${article.title}</p><p class="text-xs text-slate-400">${article.sourceName}</p></div></a>`;
                    });
                    contentHTML += '</div>';
                    topicDetailContent.innerHTML = contentHTML;
                    topicDetailModal.classList.remove('hidden');
                }
            }
        });
        closeTopicDetailModalBtn.addEventListener('click', () => topicDetailModal.classList.add('hidden'));
        topicDetailModal.addEventListener('click', (e) => { if (e.target.id === 'topicDetailModal') { topicDetailModal.classList.add('hidden'); }});
    });
</script>
</body>
</html>
